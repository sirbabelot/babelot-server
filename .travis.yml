language: node_js
env:
  DOCKER_COMPOSE_VERSION: 1.7.1
node_js:
  - '5'
sudo: required
services:
  - docker
addons:
  ssh_known_hosts:
  - 162.243.218.96
after_success:
  - docker login -e="$DOCKER_EMAIL" -u="$DOCKER_USERNAME" -p="$DOCKER_PASSWORD"
  - docker-compose -f docker-compose.yml -f docker-compose.override.yml -f docker-compose.prod.yml build app
  - docker-compose -f docker-compose.yml -f docker-compose.override.yml -f docker-compose.prod.yml build nginx
  - docker-compose -f docker-compose.yml -f docker-compose.override.yml -f docker-compose.prod.yml build chatterpillar
  - docker-compose -f docker-compose.yml -f docker-compose.override.yml -f docker-compose.prod.yml build slack
  - docker push bablot/app
  - docker push bablot/nginx
  - docker push bablot/chatterpillar
  - docker push bablot/slack
  - chmod 600 deploy_key
  - ./node_modules/.bin/shipit staging deploy
branches:
  only:
  - master
before_install:
  - sudo rm /usr/local/bin/docker-compose
  - curl -L https://github.com/docker/compose/releases/download/${DOCKER_COMPOSE_VERSION}/docker-compose-`uname -s`-`uname -m` > docker-compose
  - chmod +x docker-compose
  - sudo mv docker-compose /usr/local/bin
  - sudo mv /var/lib/docker/network/files/ /path/to/backup/docker-network-files
  - openssl aes-256-cbc -K $encrypted_39780c9b113a_key -iv $encrypted_39780c9b113a_iv
    -in deploy_key.enc -out deploy_key -d
